<template>
	<view :class="avatarClass" :style="[avatarStyle,customStyle]" @click="handleClick">
		<slot>
			<rice-icon v-if="hasStrValue(icon)" :name="icon" :size="textSize" :color="color" />
			<text v-else-if="hasStrValue(text)" :style="textStyle">{{text}}</text>
			<template v-else>
				<image :src="avatarUrl" :mode="mode" :style="imageStyle" :class="imageClass" @load="onImageLoad"
					@error="loadError"></image>
			</template>

		</slot>
	</view>
</template>

<script setup>
	/**
	 * @description Avatar 可以用来代表人物或对象， 支持使用图片、图标或者文字作为 Avatar。
	 * @property {String} src 头像路径，不能为相对路径
	 * @property {Boolean} round 是否圆形
	 * @property {String|Number} radius 圆角
	 * @property {String|Number} size 头像尺寸，可以指定为`large`,`mini` 或者数值
	 * @value large
	 * @value mini
	 * @property {String} mode 图片裁剪、缩放的模式，与 `image` 组件 `mode`参数 一致
	 * @property {String|Number} text 用文字代替图片，优先级高于 `src`
	 * @property {String} icon 显示的图标，优先级高于 `src` 和 `text`
	 * @property {String} bgColor 头像的背景颜色，一般显示文字时使用
	 * @property {String} color 文字颜色
	 * @property {String|Number} fontSize 文字/icon大小
	 * @property {String} defaultUrl 加载失败时的默认头像
	 * @property {Object} customStyle 自定义样式
	 */
	import { addUnit, hasStrValue } from "../../libs/utils"
	import { useNamespace } from "../../libs/use"
	import { AvatarProps } from './type.uts'

	defineOptions({
		name: 'rice-avatar'
	})

	const base64Avatar =
		"data:image/jpg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAA8AAD/4QMraHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjMtYzAxMSA2Ni4xNDU2NjEsIDIwMTIvMDIvMDYtMTQ6NTY6MjcgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjREMEQwRkY0RjgwNDExRUE5OTY2RDgxODY3NkJFODMxIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjREMEQwRkY1RjgwNDExRUE5OTY2RDgxODY3NkJFODMxIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NEQwRDBGRjJGODA0MTFFQTk5NjZEODE4Njc2QkU4MzEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NEQwRDBGRjNGODA0MTFFQTk5NjZEODE4Njc2QkU4MzEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAAGBAQEBQQGBQUGCQYFBgkLCAYG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";

	const ns = useNamespace('avatar')
	const emit = defineEmits<{
		click : [],
		error : [event: UniImageErrorEvent | null],
	}>()

	const props = withDefaults(defineProps<AvatarProps>(), {
		color: '#fff',
		mode: 'scaleToFill',
		round: true,
		customStyle: () : UTSJSONObject => ({})
	})

	const isLoading = ref(true)
	const avatarUrl = ref<string | null>(props.src)

	const textSize = computed(() => {
		if (hasStrValue(props.fontSize)) {
			return addUnit(props.fontSize!)
		}
		if (props.size == 'large' || props.size == 'mini') {
			return props.size == 'large' ? '20px' : '14px'
		}
		return '16px'
	})


	const loadError = (event ?: UniImageErrorEvent) => {
		isLoading.value = false
		avatarUrl.value = hasStrValue(props.defaultUrl) ? props.defaultUrl : base64Avatar
		emit('error', event)
	}

	const onImageLoad = () => {
		isLoading.value = false
	}

	watch(() : string | null => props.src, (newVal ?: string) => {
		avatarUrl.value = newVal
		if (!hasStrValue(newVal)) {
			loadError(null)
		}
	}, {
		immediate: true,
	})

	const handleClick = () => {
		emit('click')
	}



	const avatarStyle = computed(() => {
		const css = new Map<string, string>()
		if (hasStrValue(props.size) && props.size != 'large' && props.size != 'mini') {
			const size = addUnit(props.size!)
			css.set('width', size)
			css.set('height', size)
		}
		if (props.bgColor != null) {
			css.set('background', props.bgColor)
		}
		if (hasStrValue(props.radius)) {
			css.set('border-radius', addUnit(props.radius!))
		}
		return css
	})

	const imageStyle = computed(() => {
		const css = new Map<string, string>()
		if (hasStrValue(props.radius)) {
			css.set('border-radius', addUnit(props.radius!))
		}
		return css
	})

	const textStyle = computed(() => {
		const css = new Map<string, string>()
		css.set('font-size', textSize.value)
		css.set('color', props.color)
		return css
	})

	const avatarClass = computed(() => {
		const cls = [
			ns.b(""),
			ns.is('round', props.round && !hasStrValue(props.radius)),
			ns.is("text", hasStrValue(props.text) || hasStrValue(props.icon)),
			ns.theme()
		]
		if (props.size == 'large' || props.size == 'mini') {
			cls.push(ns.m(props.size))
		}
		return cls
	})



	const imageClass = computed(() => {
		const cls = [
			ns.e("image"),
			ns.is('round', props.round && !hasStrValue(props.radius)),
			ns.is("loading", isLoading.value)
		]
		if (props.size == 'large' || props.size == 'mini') {
			cls.push(ns.e(`image--${props.size}`))
		}
		return cls
	})
</script>

<style scoped lang="scss">
	.rice-avatar {
		flex-direction: row;
		align-items: center;
		justify-content: center;
		height: 48px;
		width: 48px;
		border-radius: var(--rice-radius-sm);

		&--round {
			border-radius: 999px;
		}


		&--mini {
			height: 40px;
			width: 40px;
		}

		&--large {
			height: 62px;
			width: 62px;
		}


		&__image {
			height: 100%;
			width: 100%;
			border-radius: var(--rice-radius-sm);

		}

		&--text,
		&--loading,
		&--error {
			background-color: var(--rice-image-placeholder-background);
		}


	}
</style>